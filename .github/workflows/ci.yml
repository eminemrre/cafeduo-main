name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, 'feat/**', 'fix/**']
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'

jobs:
  # ==========================================
  # Job 1: Build & Unit Tests
  # ==========================================
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Badge gÃ¼ncelleme iÃ§in tam history gerekli

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Run Unit Tests with Coverage
        id: test
        run: npm run test:coverage -- --json --outputFile=coverage/test-results.json

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Build
        run: npm run build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/
          retention-days: 7

      # Coverage deÄŸerini environment variable olarak kaydet
      - name: Extract Coverage Stats
        id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES_PCT=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct // 0')
            STATEMENTS_PCT=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct // 0')
            FUNCTIONS_PCT=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct // 0')
            BRANCHES_PCT=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct // 0')
          else
            LINES_PCT=0
            STATEMENTS_PCT=0
            FUNCTIONS_PCT=0
            BRANCHES_PCT=0
          fi
          
          echo "LINES_PCT=$LINES_PCT" >> $GITHUB_OUTPUT
          echo "STATEMENTS_PCT=$STATEMENTS_PCT" >> $GITHUB_OUTPUT
          echo "FUNCTIONS_PCT=$FUNCTIONS_PCT" >> $GITHUB_OUTPUT
          echo "BRANCHES_PCT=$BRANCHES_PCT" >> $GITHUB_OUTPUT
          
          # Badge rengini belirle
          if (( $(echo "$LINES_PCT >= 80" | bc -l) )); then
            COLOR="brightgreen"
          elif (( $(echo "$LINES_PCT >= 60" | bc -l) )); then
            COLOR="green"
          elif (( $(echo "$LINES_PCT >= 40" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          echo "BADGE_COLOR=$COLOR" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Coverage: Lines ${LINES_PCT}% | Statements ${STATEMENTS_PCT}% | Functions ${FUNCTIONS_PCT}% | Branches ${BRANCHES_PCT}%"

    outputs:
      lines_pct: ${{ steps.coverage.outputs.LINES_PCT }}
      statements_pct: ${{ steps.coverage.outputs.STATEMENTS_PCT }}
      functions_pct: ${{ steps.coverage.outputs.FUNCTIONS_PCT }}
      branches_pct: ${{ steps.coverage.outputs.BRANCHES_PCT }}
      badge_color: ${{ steps.coverage.outputs.BADGE_COLOR }}

  # ==========================================
  # Job 2: E2E Tests (Playwright)
  # ==========================================
  e2e-tests:
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 30
    
    # E2E testler artÄ±k zorunlu (continue-on-error kaldÄ±rÄ±ldÄ±)
    # Test stabilitesi iÃ§in retry mekanizmasÄ± kullanÄ±lÄ±yor
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Restore node_modules cache
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Install Playwright Browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Run Playwright E2E Tests
        id: playwright
        run: npx playwright test --reporter=list,html,junit
        env:
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL || 'test@example.com' }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD || 'testpassword123' }}

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload Playwright Screenshots
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7

      - name: Parse Test Results
        if: always()
        id: e2e-results
        run: |
          if [ -f playwright-report/results.xml ]; then
            PASSED=$(grep -o 'testsuite.*tests="[0-9]*"' playwright-report/results.xml | grep -o 'tests="[0-9]*"' | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
            FAILURES=$(grep -o 'testsuite.*failures="[0-9]*"' playwright-report/results.xml | grep -o 'failures="[0-9]*"' | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
            SKIPPED=$(grep -o 'testsuite.*skipped="[0-9]*"' playwright-report/results.xml | grep -o 'skipped="[0-9]*"' | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
            echo "PASSED=${PASSED:-0}" >> $GITHUB_OUTPUT
            echo "FAILED=${FAILURES:-0}" >> $GITHUB_OUTPUT
            echo "SKIPPED=${SKIPPED:-0}" >> $GITHUB_OUTPUT
          else
            echo "PASSED=0" >> $GITHUB_OUTPUT
            echo "FAILED=0" >> $GITHUB_OUTPUT
            echo "SKIPPED=0" >> $GITHUB_OUTPUT
          fi

    outputs:
      passed: ${{ steps.e2e-results.outputs.PASSED }}
      failed: ${{ steps.e2e-results.outputs.FAILED }}
      skipped: ${{ steps.e2e-results.outputs.SKIPPED }}

  # ==========================================
  # Job 3: Test Summary PR Comment
  # ==========================================
  pr-comment:
    runs-on: ubuntu-latest
    needs: [build-and-test, e2e-tests]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - name: Comment PR with Test Summary
        uses: actions/github-script@v7
        with:
          script: |
            const lines = '${{ needs.build-and-test.outputs.lines_pct }}';
            const statements = '${{ needs.build-and-test.outputs.statements_pct }}';
            const functions = '${{ needs.build-and-test.outputs.functions_pct }}';
            const branches = '${{ needs.build-and-test.outputs.branches_pct }}';
            const badgeColor = '${{ needs.build-and-test.outputs.badge_color }}';
            
            const e2ePassed = '${{ needs.e2e-tests.outputs.passed }}';
            const e2eFailed = '${{ needs.e2e-tests.outputs.failed }}';
            const e2eSkipped = '${{ needs.e2e-tests.outputs.skipped }}';
            
            const statusIcon = (e2eFailed === '0') ? 'âœ…' : 'âŒ';
            const e2eStatus = (e2eFailed === '0') ? 'Passed' : 'Failed';
            
            const body = `## ðŸ§ª CafeDuo Test Report
            
            ### ðŸ“Š Coverage Report
            | Metric | Value |
            |--------|-------|
            | **Lines** | ${lines}% |
            | **Statements** | ${statements}% |
            | **Functions** | ${functions}% |
            | **Branches** | ${branches}% |
            
            ![Coverage](https://img.shields.io/badge/coverage-${lines}%25-${badgeColor})
            
            ### ðŸŽ­ E2E Tests (Playwright)
            ${statusIcon} **${e2eStatus}**
            - âœ… Passed: ${e2ePassed}
            - âŒ Failed: ${e2eFailed}
            - â­ï¸ Skipped: ${e2eSkipped}
            
            ### ðŸ“¦ Artifacts
            - [View Coverage Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [View E2E Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *Generated by GitHub Actions*`;
            
            // Ã–nceki yorumlarÄ± bul ve gÃ¼ncelle
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ§ª CafeDuo Test Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ==========================================
  # Job 4: Update Coverage Badge (Main Branch)
  # ==========================================
  update-badge:
    runs-on: ubuntu-latest
    needs: [build-and-test, e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README Badge
        run: |
          COVERAGE="${{ needs.build-and-test.outputs.lines_pct }}"
          COLOR="${{ needs.build-and-test.outputs.badge_color }}"
          
          echo "Updating coverage badge to: ${COVERAGE}% (${COLOR})"
          
          # README.md'deki coverage badge'ini gÃ¼ncelle
          # Format: ![Coverage](https://img.shields.io/badge/coverage-XX%25-color)
          sed -i "s|https://img.shields.io/badge/coverage-[0-9]*%25-[a-z]*|https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR}|g" README.md
          
          # Alternatif format (flat-square vb. iÃ§in)
          sed -i "s|https://img.shields.io/badge/coverage-[0-9]*%25-[a-z]*|https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR}|g" README.md

      - name: Commit Badge Update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet README.md; then
            echo "No changes to README.md"
          else
            git add README.md
            git commit -m "ðŸ“Š Update coverage badge to ${{ needs.build-and-test.outputs.lines_pct }}%"
            git push
          fi

  # ==========================================
  # Job 5: Deploy to Staging (Main Branch)
  # ==========================================
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [build-and-test, e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: staging
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: dist/

      # Render.com Deployment
      - name: Deploy to Render (Staging)
        if: secrets.RENDER_SERVICE_ID != ''
        id: deploy-render
        run: |
          echo "ðŸš€ Deploying to Render..."
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys
          echo "url=https://cafeduo-staging.onrender.com" >> $GITHUB_OUTPUT

      # Railway Deployment
      - name: Deploy to Railway (Staging)
        if: secrets.RAILWAY_TOKEN != ''
        id: deploy-railway
        run: |
          echo "ðŸš€ Deploying to Railway..."
          npm install -g @railway/cli
          railway login --token ${{ secrets.RAILWAY_TOKEN }}
          railway up --service cafeduo-staging
          echo "url=https://cafeduo-staging.up.railway.app" >> $GITHUB_OUTPUT

      # Netlify Deployment (Frontend)
      - name: Deploy to Netlify (Frontend)
        if: secrets.NETLIFY_AUTH_TOKEN != '' && secrets.NETLIFY_SITE_ID != ''
        id: deploy-netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './dist'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: false
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Set Deployment URL
        id: deploy
        run: |
          if [ -n "${{ steps.deploy-render.outputs.url }}" ]; then
            echo "url=${{ steps.deploy-render.outputs.url }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ steps.deploy-railway.outputs.url }}" ]; then
            echo "url=${{ steps.deploy-railway.outputs.url }}" >> $GITHUB_OUTPUT
          else
            echo "url=https://cafeduo-staging.netlify.app" >> $GITHUB_OUTPUT
          fi

      - name: Notify Deployment
        run: |
          echo "âœ… Staging deployment complete: ${{ steps.deploy.outputs.url }}"
