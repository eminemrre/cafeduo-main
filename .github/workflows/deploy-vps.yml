name: Deploy VPS

on:
  workflow_dispatch:
  push:
    branches: [main]

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate deploy secrets
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_ENV_B64: ${{ secrets.DEPLOY_ENV_B64 }}
        run: |
          set -euo pipefail
          for var in DEPLOY_HOST DEPLOY_USER DEPLOY_SSH_KEY DEPLOY_PATH DEPLOY_ENV_B64; do
            if [ -z "${!var:-}" ]; then
              echo "Missing required secret: ${var}"
              exit 1
            fi
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:ci

      - name: Build frontend
        run: npm run build

      - name: Setup SSH
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${DEPLOY_PORT:-22}" "$DEPLOY_HOST" >> ~/.ssh/known_hosts

      - name: Create deployment backup on VPS
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -euo pipefail
          ssh -p "${DEPLOY_PORT:-22}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "if [ -d '${DEPLOY_PATH}' ]; then \
               rm -rf '${DEPLOY_PATH}_backup_latest'; \
               mkdir -p '${DEPLOY_PATH}_backup_latest'; \
               rsync -a --delete '${DEPLOY_PATH}/' '${DEPLOY_PATH}_backup_latest/'; \
             fi"

      - name: Sync project to VPS
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -euo pipefail
          ssh -p "${DEPLOY_PORT:-22}" "${DEPLOY_USER}@${DEPLOY_HOST}" "mkdir -p ${DEPLOY_PATH}"
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".env" \
            --exclude "node_modules" \
            --exclude "coverage" \
            --exclude "dist" \
            --exclude "playwright-report" \
            --exclude "test-results" \
            -e "ssh -p ${DEPLOY_PORT:-22}" \
            ./ "${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}"

      - name: Deploy containers on VPS
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_ENV_B64: ${{ secrets.DEPLOY_ENV_B64 }}
        run: |
          set -euo pipefail
          ssh -p "${DEPLOY_PORT:-22}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "DEPLOY_PATH='${DEPLOY_PATH}' DEPLOY_ENV_B64='${DEPLOY_ENV_B64}' bash -s" <<'REMOTE'
            set -euo pipefail

            if ! command -v docker >/dev/null 2>&1; then
              apt-get update
              apt-get install -y docker.io
              systemctl enable --now docker
            fi

            if docker compose version >/dev/null 2>&1; then
              run_compose() { docker compose "$@"; }
            else
              if ! command -v docker-compose >/dev/null 2>&1; then
                apt-get update
                apt-get install -y docker-compose-v2 || apt-get install -y docker-compose
              fi

              if docker compose version >/dev/null 2>&1; then
                run_compose() { docker compose "$@"; }
              else
                run_compose() { docker-compose "$@"; }
              fi
            fi

            cd "$DEPLOY_PATH"
            echo "$DEPLOY_ENV_B64" | base64 -d > .env
            run_compose -f deploy/docker-compose.prod.yml --env-file .env up -d --build --remove-orphans
            docker image prune -f
          REMOTE

      - name: Run VPS smoke checks
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -euo pipefail
          ssh -p "${DEPLOY_PORT:-22}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "cd '${DEPLOY_PATH}' && bash deploy/scripts/smoke-vps.sh http://127.0.0.1"

      - name: Run public smoke checks
        if: ${{ secrets.DEPLOY_SITE_URL != '' }}
        env:
          SMOKE_BASE_URL: ${{ secrets.DEPLOY_SITE_URL }}
        run: npm run smoke:prod
